{% extends "base.html" %}

{% block title %}商品群別進捗分析 - {{ mentee.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>
                        <i class="fas fa-chart-line me-2"></i>商品群別進捗分析
                    </h2>
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        順調: 7日以内に報告 / 注意: 8-14日 / 停滞: 15日以上
                    </small>
                </div>
                {% if current_user.role in ['mentor', 'admin'] %}
                    <a href="{{ url_for('mentor_dashboard') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> メンターダッシュボードに戻る
                    </a>
                {% else %}
                    <a href="{{ url_for('mentee_dashboard', mentee_id=mentee.id) }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> ダッシュボードに戻る
                    </a>
                {% endif %}
            </div>
            {% if current_user.role in ['mentor', 'admin'] %}
            <div class="col-md-6 text-end">
                <div class="alert alert-info alert-sm py-2 mb-0">
                    <i class="fas fa-chalkboard-teacher me-2"></i>
                    <small>メンター視点でメンティの進捗を確認中</small>
                </div>
            </div>
            {% endif %}

        <!-- フィルター状態表示 -->
        <div class="alert alert-info alert-dismissible fade show" id="filter-status" style="display: none;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-filter me-2"></i>
                    <span id="filter-status-text"></span>
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="reset-filter-main">
                    <i class="fas fa-undo-alt me-1"></i>フィルター解除
                </button>
            </div>
        </div>

            <!-- 期間選択とメンティ切り替え -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">分析設定</h5>
                        {% if current_user.role in ['mentor', 'admin'] and all_mentees|length > 1 %}
                        <div class="mentee-switcher-badge">
                            <i class="fas fa-users me-1"></i>
                            <span class="badge bg-primary">{{ all_mentees|length }}名のメンティ</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <!-- メンティ切り替え（メンター・管理者のみ） -->
                        {% if current_user.role in ['mentor', 'admin'] and all_mentees|length > 1 %}
                        <div class="col-md-4 mb-3 mb-md-0">
                            <label for="mentee-switcher" class="form-label mb-2">
                                <i class="fas fa-user-graduate me-1"></i>メンティ選択:
                            </label>
                            <select id="mentee-switcher" class="form-select mentee-select">
                                {% for m in all_mentees %}
                                <option value="{{ m.id }}" {% if m.id == mentee.id %}selected{% endif %}>
                                    {{ m.name }}
                                    {% if m.id == mentee.id %}（現在表示中）{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}
                        
                        <!-- 期間選択 -->
                        <div class="{% if current_user.role in ['mentor', 'admin'] and all_mentees|length > 1 %}col-md-4{% else %}col-md-8{% endif %} mb-3 mb-md-0">
                            <form method="GET" class="d-flex align-items-center">
                                {% if current_user.role in ['mentor', 'admin'] %}
                                <input type="hidden" name="mentee_id" value="{{ mentee.id }}">
                                {% endif %}
                                <label for="weeks" class="form-label me-3 mb-0">
                                    <i class="fas fa-calendar-alt me-1"></i>分析期間:
                                </label>
                                <select name="weeks" id="weeks" class="form-select" style="width: auto;" onchange="this.form.submit()">
                                    <option value="4" {% if selected_weeks == 4 %}selected{% endif %}>直近4週間</option>
                                    <option value="8" {% if selected_weeks == 8 %}selected{% endif %}>直近8週間</option>
                                    <option value="12" {% if selected_weeks == 12 %}selected{% endif %}>直近12週間</option>
                                    <option value="24" {% if selected_weeks == 24 %}selected{% endif %}>直近24週間</option>
                                    <option value="52" {% if selected_weeks == 52 %}selected{% endif %}>直近52週間（1年）</option>
                                </select>
                            </form>
                        </div>
                        
                        <!-- 統計情報 -->
                        <div class="{% if current_user.role in ['mentor', 'admin'] and all_mentees|length > 1 %}col-md-4{% else %}col-md-4{% endif %} text-end">
                            <div class="analysis-stats">
                                <div class="stat-item">
                                    <i class="fas fa-chart-pie me-1 text-primary"></i>
                                    <span class="stat-number">{{ product_group_progress|length }}</span>
                                    <small class="text-muted">個の商品群</small>
                                </div>
                                <div class="stat-item mt-1">
                                    <i class="fas fa-user me-1 text-success"></i>
                                    <span class="stat-name">{{ mentee.name }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% if product_group_progress %}
            <div class="row">
                <!-- メインコンテンツ -->
                <div class="col-lg-9">
                    <!-- 進捗サマリー -->
                    <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-success">
                                <i class="fas fa-arrow-up"></i>
                                {{ product_group_progress|selectattr('progress_status', 'equalto', 'good')|list|length }}
                            </h5>
                            <p class="card-text">順調</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-warning">
                                <i class="fas fa-pause"></i>
                                {{ product_group_progress|selectattr('progress_status', 'equalto', 'warning')|list|length }}
                            </h5>
                            <p class="card-text">注意</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-danger">
                                <i class="fas fa-exclamation-triangle"></i>
                                {{ product_group_progress|selectattr('progress_status', 'equalto', 'danger')|list|length }}
                            </h5>
                            <p class="card-text">停滞</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-primary">
                                <i class="fas fa-boxes"></i>
                                {{ product_group_progress|length }}
                            </h5>
                            <p class="card-text">総商品群数</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 商品群別詳細分析 -->
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">商品群別詳細分析</h5>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="reset-filter-header" style="display: none;">
                            <i class="fas fa-undo-alt me-1"></i>フィルター解除
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for pg in product_group_progress %}
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header py-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <span class="stage-number-badge me-2" data-stage="{{ pg.current_stage }}">
                                                {% set stage_number_mapping = {
                                                    'proposal_pre': 0,
                                                    'estimate_completed': 1,
                                                    's_creation_approved': 2,
                                                    'proposal_decision_obtained': 3,
                                                    'pre_production_s_confirmed': 4,
                                                    'first_order': 5,
                                                    'temporary_listing': 6,
                                                    'page_up': 7,
                                                    'second_lot_ordered': 8,
                                                    'project_cancelled': 9
                                                } %}
                                                {{ stage_number_mapping.get(pg.current_stage, '?') }}
                                            </span>
                                            {{ pg.name }}
                                        </h6>
                                        <span class="badge bg-{{ get_progress_status_info(pg.progress_status).class }}">
                                            <i class="{{ get_progress_status_info(pg.progress_status).icon }} me-1"></i>
                                            {{ get_progress_status_info(pg.progress_status).text }}
                                        </span>
                                    </div>
                                </div>
                                <div class="card-body py-2">
                                    <!-- 商品群画像 -->
                                    {% if pg.images %}
                                        {% set image_list = pg.images|from_json %}
                                        {% if image_list and image_list|length > 0 %}
                                        <div class="text-center mb-2">
                                            <img src="{{ url_for('static', filename='uploads/product_groups/' + image_list[0]) }}" 
                                                 class="img-fluid rounded" 
                                                 style="max-height: 80px; max-width: 100%; object-fit: contain;"
                                                 alt="{{ pg.name }}の画像">
                                        </div>
                                        {% endif %}
                                    {% endif %}
                                    
                                    <!-- 現在のステージ情報 -->
                                    <div class="row mb-2">
                                        <div class="col-6">
                                            <small class="text-muted">現在のステージ:</small><br>
                                            <span class="badge bg-primary">{{ get_stage_display_name(pg.current_stage) }}</span>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">最後の報告:</small><br>
                                            <span class="text-{{ get_progress_status_info(pg.progress_status).class }}">
                                                {{ pg.stage_duration }}日前
                                            </span>
                                        </div>
                                    </div>

                                    <!-- 進捗バー -->
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="text-muted">進捗状況</small>
                                            <small class="text-muted">
                                                {% set stage_progress = {
                                                    'proposal_pre': 11, 
                                                    'estimate_completed': 22, 
                                                    's_creation_approved': 33, 
                                                    'proposal_decision_obtained': 44, 
                                                    'pre_production_s_confirmed': 56, 
                                                    'first_order': 67, 
                                                    'temporary_listing': 78, 
                                                    'page_up': 89, 
                                                    'second_lot_ordered': 100,
                                                    'project_cancelled': 100
                                                } %}
                                                {{ stage_progress.get(pg.current_stage, 0) }}%
                                            </small>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar bg-{{ get_progress_status_info(pg.progress_status).class }}" 
                                                 role="progressbar" 
                                                 style="width: {{ stage_progress.get(pg.current_stage, 0) }}%"
                                                 aria-valuenow="{{ stage_progress.get(pg.current_stage, 0) }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 報告履歴（スクロール可能） -->
                                    <div class="mb-2">
                                        <small class="text-muted">報告履歴</small>
                                        {% if pg.reports %}
                                            <div class="mt-1 report-history-scroll">
                                                {% for report in pg.reports %}
                                                <div class="d-flex align-items-center mb-1 report-item" 
                                                     style="cursor: pointer; padding: 4px; border-radius: 4px; transition: background-color 0.2s; {% if report.self_evaluation and report.self_evaluation == 1 %}border-left: 3px solid #dc3545;{% elif report.self_evaluation and report.self_evaluation == 2 %}border-left: 3px solid #ffc107;{% endif %}" 
                                                     onmouseover="this.style.backgroundColor='#f8f9fa'" 
                                                     onmouseout="this.style.backgroundColor='transparent'"
                                                     onclick="window.location.href='{{ url_for('view_report', report_id=report.id) }}'">
                                                    <div class="bg-{{ get_progress_status_info(pg.progress_status).class }} me-2" style="width: 4px; height: 4px; border-radius: 50%;"></div>
                                                    <small class="text-muted flex-grow-1">
                                                        {{ report.date.strftime('%m/%d') }} - 
                                                        {{ get_stage_display_name(report.stage) }}
                                                        {% if report.self_evaluation %}
                                                            <span class="ms-1">
                                                                {% for i in range(1, 4) %}
                                                                    {% if i <= report.self_evaluation %}
                                                                        {% if report.self_evaluation == 1 %}
                                                                            <span class="text-danger">★</span>
                                                                        {% else %}
                                                                            <span class="text-warning">★</span>
                                                                        {% endif %}
                                                                    {% else %}
                                                                        <span class="text-muted">☆</span>
                                                                    {% endif %}
                                                                {% endfor %}
                                                            </span>
                                                        {% endif %}
                                                    </small>
                                                    <small class="text-muted">
                                                        <i class="fas fa-external-link-alt" style="font-size: 10px;"></i>
                                                    </small>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <small class="text-muted">報告なし</small>
                                        {% endif %}
                                    </div>

                                    <!-- 推奨アクション（簡略化） -->
                                    <div class="alert alert-{{ 'success' if pg.progress_status == 'good' else 'warning' if pg.progress_status == 'warning' else 'danger' }} alert-sm py-1">
                                        <small>
                                            {% if pg.progress_status == 'good' %}
                                                定期的に報告されています。継続してください。
                                            {% elif pg.progress_status == 'warning' %}
                                                1週間以上報告がありません。今週中に報告をお勧めします。
                                            {% elif pg.progress_status == 'danger' %}
                                                2週間以上報告がありません。早急にメンターと対策を検討してください。
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
                </div>
                
                <!-- サイドバー -->
                <div class="col-lg-3">
                    <!-- 進捗ステージ一覧 -->
                    <div class="card mb-4 sticky-top" style="top: 20px;">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-list-ol me-2"></i>進捗ステージ一覧
                                </h6>
                                <button class="btn btn-sm btn-outline-secondary" id="reset-filter" title="フィルターをリセット">
                                    <i class="fas fa-undo-alt"></i>
                                </button>
                            </div>
                            <small class="text-muted">クリックで絞り込み</small>
                        </div>
                        <div class="card-body p-2">
                            <div class="progress-stages-sidebar">
                                <div class="progress-stage-item-sidebar filterable" data-stage="proposal_pre" data-filter="all">
                                    <div class="stage-number-sidebar">0</div>
                                    <div class="stage-info-sidebar">
                                        <div class="stage-name-sidebar">提案前</div>
                                        <div class="stage-percentage-sidebar">11%</div>
                                    </div>
                                    <div class="stage-count-badge" data-stage="proposal_pre">0</div>
                                </div>
                                <div class="progress-stage-item-sidebar filterable" data-stage="estimate_completed" data-filter="all">
                                    <div class="stage-number-sidebar">1</div>
                                    <div class="stage-info-sidebar">
                                        <div class="stage-name-sidebar">見積書対応済</div>
                                        <div class="stage-percentage-sidebar">22%</div>
                                    </div>
                                    <div class="stage-count-badge" data-stage="estimate_completed">0</div>
                                </div>
                                <div class="progress-stage-item-sidebar filterable" data-stage="s_creation_approved" data-filter="all">
                                    <div class="stage-number-sidebar">2</div>
                                    <div class="stage-info-sidebar">
                                        <div class="stage-name-sidebar">S作成承認済</div>
                                        <div class="stage-percentage-sidebar">33%</div>
                                    </div>
                                    <div class="stage-count-badge" data-stage="s_creation_approved">0</div>
                                </div>
                                <div class="progress-stage-item-sidebar filterable" data-stage="proposal_decision_obtained" data-filter="all">
                                    <div class="stage-number-sidebar">3</div>
                                    <div class="stage-info-sidebar">
                                        <div class="stage-name-sidebar">提案決裁取得済</div>
                                        <div class="stage-percentage-sidebar">44%</div>
                                    </div>
                                    <div class="stage-count-badge" data-stage="proposal_decision_obtained">0</div>
                                </div>
                                <div class="progress-stage-item-sidebar filterable" data-stage="pre_production_s_confirmed" data-filter="all">
                                    <div class="stage-number-sidebar">4</div>
                                    <div class="stage-info-sidebar">
                                        <div class="stage-name-sidebar">量産前S確認済</div>
                                        <div class="stage-percentage-sidebar">56%</div>
                                    </div>
                                    <div class="stage-count-badge" data-stage="pre_production_s_confirmed">0</div>
                                </div>
                                <div class="progress-stage-item-sidebar filterable" data-stage="first_order" data-filter="all">
                                    <div class="stage-number-sidebar">5</div>
                                    <div class="stage-info-sidebar">
                                        <div class="stage-name-sidebar">初回発注済</div>
                                        <div class="stage-percentage-sidebar">67%</div>
                                    </div>
                                    <div class="stage-count-badge" data-stage="first_order">0</div>
                                </div>
                                <div class="progress-stage-item-sidebar filterable" data-stage="temporary_listing" data-filter="all">
                                    <div class="stage-number-sidebar">6</div>
                                    <div class="stage-info-sidebar">
                                        <div class="stage-name-sidebar">仮出品済</div>
                                        <div class="stage-percentage-sidebar">78%</div>
                                    </div>
                                    <div class="stage-count-badge" data-stage="temporary_listing">0</div>
                                </div>
                                <div class="progress-stage-item-sidebar filterable" data-stage="page_up" data-filter="all">
                                    <div class="stage-number-sidebar">7</div>
                                    <div class="stage-info-sidebar">
                                        <div class="stage-name-sidebar">ページアップ済</div>
                                        <div class="stage-percentage-sidebar">89%</div>
                                    </div>
                                    <div class="stage-count-badge" data-stage="page_up">0</div>
                                </div>
                                <div class="progress-stage-item-sidebar filterable" data-stage="second_lot_ordered" data-filter="all">
                                    <div class="stage-number-sidebar">8</div>
                                    <div class="stage-info-sidebar">
                                        <div class="stage-name-sidebar">2ロット目発注済</div>
                                        <div class="stage-percentage-sidebar">100%</div>
                                    </div>
                                    <div class="stage-count-badge" data-stage="second_lot_ordered">0</div>
                                </div>
                                <div class="progress-stage-item-sidebar filterable" data-stage="project_cancelled" data-filter="all">
                                    <div class="stage-number-sidebar">9</div>
                                    <div class="stage-info-sidebar">
                                        <div class="stage-name-sidebar">企画中止</div>
                                        <div class="stage-percentage-sidebar">100%</div>
                                    </div>
                                    <div class="stage-count-badge" data-stage="project_cancelled">0</div>
                                </div>
                            </div>
                            <div class="text-center mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    進捗確認
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- データなしの場合 -->
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">分析データがありません</h5>
                    <p class="text-muted">週次報告を作成すると、ここに進捗分析が表示されます。</p>
                    <a href="{{ url_for('new_report', mentee_id=mentee.id) }}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>最初の報告を作成
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
/* サイドバー用進捗ステージ一覧のスタイリング */
.progress-stages-sidebar {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

/* ヘッダーのテキスト色を白に */
.card-header h6 {
    color: white !important;
}

.card-header .text-muted {
    color: rgba(255, 255, 255, 0.7) !important;
}

.card-header i {
    color: white !important;
}

.progress-stage-item-sidebar {
    display: flex;
    align-items: center;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 6px 8px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.progress-stage-item-sidebar:hover {
    background: #e9ecef;
    border-color: #007bff;
    transform: translateX(2px);
}

.stage-number-sidebar {
    background: #007bff;
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: bold;
    margin-right: 6px;
    flex-shrink: 0;
}

.stage-info-sidebar {
    flex: 1;
    min-width: 0;
}

.stage-name-sidebar {
    font-size: 0.75rem;
    font-weight: 600;
    color: #495057;
    line-height: 1.2;
    margin-bottom: 1px;
}

.stage-percentage-sidebar {
    font-size: 0.65rem;
    color: #6c757d;
    font-weight: 500;
}

/* 現在のステージのハイライト（サイドバー用） */
.progress-stage-item-sidebar.current-stage {
    border-color: #28a745;
    background: #d4edda;
    box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
}

.progress-stage-item-sidebar.current-stage .stage-number-sidebar {
    background: #28a745;
}

.progress-stage-item-sidebar.completed-stage {
    border-color: #17a2b8;
    background: #d1ecf1;
}

.progress-stage-item-sidebar.completed-stage .stage-number-sidebar {
    background: #17a2b8;
}

/* フィルター可能なステージ項目 */
.progress-stage-item-sidebar.filterable {
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.progress-stage-item-sidebar.filterable:hover {
    background: #e3f2fd;
    border-color: #2196f3;
    transform: translateX(4px);
}

.progress-stage-item-sidebar.filterable.active-filter {
    background: #e8f5e8;
    border-color: #28a745;
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
}

/* ステージカウントバッジ */
.stage-count-badge {
    position: absolute;
    top: 4px;
    right: 4px;
    background: #6c757d;
    color: white;
    font-size: 0.6rem;
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 10px;
    min-width: 16px;
    text-align: center;
    opacity: 0.7;
    transition: all 0.3s ease;
}

.progress-stage-item-sidebar.filterable:hover .stage-count-badge {
    opacity: 1;
    transform: scale(1.1);
}

.progress-stage-item-sidebar.filterable.active-filter .stage-count-badge {
    background: #28a745;
    opacity: 1;
}

/* フィルター解除ボタンのスタイル */
#reset-filter-main, #reset-filter-header {
    transition: all 0.3s ease;
    color: white !important;
}

#reset-filter-main:hover, #reset-filter-header:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    color: white !important;
}

#reset-filter-header {
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* レスポンシブ対応 */
@media (max-width: 992px) {
    .progress-stage-item-sidebar {
        padding: 8px 10px;
    }
    
    .stage-name-sidebar {
        font-size: 0.8rem;
    }
    
    .stage-percentage-sidebar {
        font-size: 0.7rem;
    }
    
    .stage-number-sidebar {
        width: 22px;
        height: 22px;
        font-size: 0.75rem;
    }
}

/* カードのステージ番号バッジ */
.stage-number-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border-radius: 50%;
    font-size: 0.75rem;
    font-weight: bold;
    border: 2px solid #fff;
    box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
    transition: all 0.3s ease;
}

.stage-number-badge:hover {
    transform: scale(1.1);
    box-shadow: 0 3px 6px rgba(0, 123, 255, 0.4);
}

/* ステージ番号バッジの色分け */
.stage-number-badge[data-stage="proposal_pre"] {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
}

.stage-number-badge[data-stage="estimate_completed"] {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
}

.stage-number-badge[data-stage="s_creation_approved"] {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
}

.stage-number-badge[data-stage="proposal_decision_obtained"] {
    background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
    color: #212529;
}

.stage-number-badge[data-stage="pre_production_s_confirmed"] {
    background: linear-gradient(135deg, #fd7e14 0%, #e55100 100%);
}

.stage-number-badge[data-stage="first_order"] {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
}

.stage-number-badge[data-stage="temporary_listing"] {
    background: linear-gradient(135deg, #6f42c1 0%, #59359a 100%);
}

.stage-number-badge[data-stage="page_up"] {
    background: linear-gradient(135deg, #e83e8c 0%, #d63384 100%);
}

.stage-number-badge[data-stage="second_lot_ordered"] {
    background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
}

.stage-number-badge[data-stage="project_cancelled"] {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
}

.timeline {
    position: relative;
    padding-left: 20px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 4px;
    top: 0;
    bottom: 0;
    width: 2px;
    background-color: #dee2e6;
}

.timeline-item {
    position: relative;
}

.timeline-marker {
    position: absolute;
    left: -20px;
    top: 50%;
    transform: translateY(-50%);
}

.alert-sm {
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
}

/* 報告履歴のスクロールバーをカスタマイズ */
.report-history-scroll {
    max-height: 80px;
    overflow-y: auto;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 8px;
}

.report-history-scroll::-webkit-scrollbar {
    width: 4px;
}

.report-history-scroll::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 2px;
}

.report-history-scroll::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 2px;
}

.report-history-scroll::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* 現在のステージのハイライト */
.progress-stage-item.current-stage {
    border-color: #28a745;
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
}

.progress-stage-item.current-stage .stage-number {
    background: #28a745;
}

.progress-stage-item.completed-stage {
    border-color: #17a2b8;
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
}

.progress-stage-item.completed-stage .stage-number {
    background: #17a2b8;
}

/* メンティ切り替え機能のスタイル */
.mentee-switcher-badge {
    display: flex;
    align-items: center;
    gap: 8px;
}

.mentee-switcher-badge .badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
}

.mentee-select {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    transition: all 0.3s ease;
    background: white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.mentee-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25), 0 4px 8px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
}

.mentee-select:hover {
    border-color: #6c757d;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.12);
}

.mentee-select option {
    padding: 8px 12px;
}

.mentee-select option:checked {
    background: linear-gradient(135deg, #0d6efd, #0b5ed7);
    color: white;
}

.mentee-switch-loading {
    margin-top: 8px;
    padding: 8px;
    background: rgba(13, 110, 253, 0.1);
    border-radius: 6px;
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* 分析統計のスタイル */
.analysis-stats {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.stat-number {
    font-weight: 700;
    color: #495057;
    font-size: 1.1rem;
}

.stat-name {
    font-weight: 600;
    color: #28a745;
    font-size: 0.9rem;
}

/* ラベルのアイコンスタイル */
.form-label i {
    color: #6c757d;
    margin-right: 4px;
}

/* カードヘッダーの改善 */
.card-header .d-flex {
    align-items: center;
}

.card-header h5 {
    margin: 0;
    color: #495057;
    font-weight: 600;
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
    .mentee-switcher-badge {
        margin-top: 8px;
    }
    
    .analysis-stats {
        text-align: center !important;
        margin-top: 15px;
    }
    
    .stat-item {
        justify-content: center;
    }
    
    .mentee-select {
        font-size: 0.9rem;
    }
}

/* ホバー効果の改善 */
.mentee-select:hover:not(:focus) {
    background: linear-gradient(135deg, #fff, #f8f9fa);
}

/* フォーカス時のアニメーション */
.mentee-select:focus {
    animation: focusGlow 0.3s ease-in-out;
}

@keyframes focusGlow {
    0% {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    50% {
        box-shadow: 0 0 0 0.1rem rgba(13, 110, 253, 0.15), 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    100% {
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25), 0 4px 8px rgba(0, 0, 0, 0.15);
    }
}

/* ローディング中のスタイル */
.mentee-select:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    background: #f8f9fa;
}

/* ツールチップのスタイル改善 */
.tooltip {
    font-size: 0.8rem;
}

.tooltip-inner {
    background: #495057;
    border-radius: 6px;
    padding: 6px 10px;
}

</style>

<script>
// メンティ切り替え機能
function initMenteeSwitcher() {
    const menteeSwitcher = document.getElementById('mentee-switcher');
    if (!menteeSwitcher) return;
    
    menteeSwitcher.addEventListener('change', function() {
        const selectedMenteeId = this.value;
        const currentUrl = new URL(window.location.href);
        const weeks = currentUrl.searchParams.get('weeks') || '12';
        
        // ローディング表示
        showMenteeSwitchLoading(true);
        
        // 新しいURLを構築
        const newUrl = `/mentee/${selectedMenteeId}/product-group-analysis?weeks=${weeks}`;
        
        // ページ遷移
        window.location.href = newUrl;
    });
}

// メンティ切り替え時のローディング表示
function showMenteeSwitchLoading(show) {
    const menteeSwitcher = document.getElementById('mentee-switcher');
    const loadingElement = document.getElementById('mentee-switch-loading');
    
    if (!menteeSwitcher) return;
    
    if (show) {
        menteeSwitcher.disabled = true;
        
        // ローディング要素がない場合は作成
        if (!loadingElement) {
            const loading = document.createElement('div');
            loading.id = 'mentee-switch-loading';
            loading.className = 'mentee-switch-loading';
            loading.innerHTML = `
                <div class="d-flex align-items-center text-primary">
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">読み込み中...</span>
                    </div>
                    <small>メンティを切り替え中...</small>
                </div>
            `;
            menteeSwitcher.parentNode.appendChild(loading);
        } else {
            loadingElement.style.display = 'block';
        }
    } else {
        menteeSwitcher.disabled = false;
        if (loadingElement) {
            loadingElement.style.display = 'none';
        }
    }
}

// メンティ切り替えのキーボードショートカット
function initMenteeSwitcherKeyboard() {
    document.addEventListener('keydown', function(e) {
        // Ctrl + M でメンティ切り替えにフォーカス
        if (e.ctrlKey && e.key === 'm') {
            e.preventDefault();
            const menteeSwitcher = document.getElementById('mentee-switcher');
            if (menteeSwitcher) {
                menteeSwitcher.focus();
                menteeSwitcher.click();
            }
        }
    });
}

// メンティ切り替えのツールチップ表示
function initMenteeSwitcherTooltip() {
    const menteeSwitcher = document.getElementById('mentee-switcher');
    if (!menteeSwitcher) return;
    
    // Bootstrap tooltipを初期化
    if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
        new bootstrap.Tooltip(menteeSwitcher, {
            title: 'Ctrl + M でフォーカス',
            placement: 'top',
            trigger: 'hover'
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // メンティ切り替え機能を初期化
    initMenteeSwitcher();
    initMenteeSwitcherKeyboard();
    initMenteeSwitcherTooltip();
    
    // 現在のステージをハイライト表示（サイドバー用）
    function highlightCurrentStages() {
        const stageItems = document.querySelectorAll('.progress-stage-item-sidebar');
        const productGroups = document.querySelectorAll('.col-lg-3.col-md-6');
        
        // 各商品群の現在のステージを取得
        const currentStages = [];
        productGroups.forEach(function(group) {
            const badge = group.querySelector('.badge');
            if (badge) {
                const stageText = badge.textContent.trim();
                // ステージ名を抽出（表示名から内部名に変換）
                const stageMapping = {
                    '提案前': 'proposal_pre',
                    '見積書対応済': 'estimate_completed',
                    'S作成承認済': 's_creation_approved',
                    '提案決裁取得済': 'proposal_decision_obtained',
                    '量産前S確認済': 'pre_production_s_confirmed',
                    '初回発注済': 'first_order',
                    '仮出品済': 'temporary_listing',
                    'ページアップ済': 'page_up',
                    '2ロット目発注済': 'second_lot_ordered',
                    '企画中止': 'project_cancelled'
                };
                
                const stageKey = Object.keys(stageMapping).find(key => stageText.includes(key));
                if (stageKey) {
                    currentStages.push(stageMapping[stageKey]);
                }
            }
        });
        
        // ステージアイテムのハイライトを更新
        stageItems.forEach(function(item) {
            const stageId = item.getAttribute('data-stage');
            item.classList.remove('current-stage', 'completed-stage');
            
            if (currentStages.includes(stageId)) {
                item.classList.add('current-stage');
            } else {
                // 完了済みステージの判定（現在のステージより前のステージ）
                const stageOrder = [
                    'proposal_pre', 'estimate_completed', 's_creation_approved',
                    'proposal_decision_obtained', 'pre_production_s_confirmed',
                    'first_order', 'temporary_listing', 'page_up', 'second_lot_ordered', 'project_cancelled'
                ];
                
                const currentStageIndex = Math.max(...currentStages.map(stage => stageOrder.indexOf(stage)));
                const itemIndex = stageOrder.indexOf(stageId);
                
                if (itemIndex < currentStageIndex && itemIndex >= 0) {
                    item.classList.add('completed-stage');
                }
            }
        });
    }
    
    
    // ページ読み込み時に実行
    highlightCurrentStages();
    
    // フィルター機能（少し遅延して実行）
    setTimeout(function() {
        initStageFilter();
    }, 100);
});

// ステージフィルター機能
function initStageFilter() {
    const filterableStages = document.querySelectorAll('.filterable');
    const productGroups = document.querySelectorAll('.col-lg-3.col-md-6');
    const filterStatus = document.getElementById('filter-status');
    const filterStatusText = document.getElementById('filter-status-text');
    const resetFilterBtn = document.getElementById('reset-filter');
    
    console.log('フィルター機能初期化:', {
        filterableStages: filterableStages.length,
        productGroups: productGroups.length,
        filterStatus: filterStatus,
        resetFilterBtn: resetFilterBtn
    });
    
    // ステージごとの商品群数をカウント
    function updateStageCounts() {
        const stageCounts = {};
        
        // より確実に商品群カードを取得
        let allProductGroups = document.querySelectorAll('.col-lg-3.col-md-6, .col-md-6.col-lg-3, .col-sm-6.col-md-6');
        
        // 上記で見つからない場合は、より広範囲で検索
        if (allProductGroups.length === 0) {
            allProductGroups = document.querySelectorAll('.col-md-6, .col-lg-3, .col-sm-6');
        }
        
        // それでも見つからない場合は、カードクラスで検索
        if (allProductGroups.length === 0) {
            allProductGroups = document.querySelectorAll('.card, .modern-card');
        }
        
        console.log('商品群カード数:', allProductGroups.length);
        
        allProductGroups.forEach(function(group, index) {
            // ステージ番号バッジからdata-stage属性を取得
            const stageNumberBadge = group.querySelector('.stage-number-badge');
            if (stageNumberBadge) {
                const stageKey = stageNumberBadge.getAttribute('data-stage');
                console.log(`カウント対象商品群${index + 1}のステージ: "${stageKey}"`);
                
                if (stageKey) {
                    stageCounts[stageKey] = (stageCounts[stageKey] || 0) + 1;
                    console.log(`ステージ${stageKey}のカウント: ${stageCounts[stageKey]}`);
                }
            } else {
                console.log(`カウント対象商品群${index + 1}: ステージ番号バッジが見つからない`);
            }
        });
        
        console.log('ステージカウント:', stageCounts);
        
        // カウントバッジを更新
        filterableStages.forEach(function(stage) {
            const stageKey = stage.getAttribute('data-stage');
            const countBadge = stage.querySelector('.stage-count-badge');
            const count = stageCounts[stageKey] || 0;
            countBadge.textContent = count;
            countBadge.style.display = count > 0 ? 'block' : 'none';
        });
    }
    
    // フィルター適用
    function applyFilter(selectedStage) {
        console.log('フィルター適用:', selectedStage);
        
        // 全てのステージ項目のアクティブ状態をリセット
        filterableStages.forEach(function(stage) {
            stage.classList.remove('active-filter');
        });
        
        // 選択されたステージをアクティブにする
        if (selectedStage !== 'all') {
            const selectedStageElement = document.querySelector(`[data-stage="${selectedStage}"]`);
            if (selectedStageElement) {
                selectedStageElement.classList.add('active-filter');
            }
        }
        
        // より確実に商品群カードを取得
        let allProductGroups = document.querySelectorAll('.col-lg-3.col-md-6, .col-md-6.col-lg-3, .col-sm-6.col-md-6');
        
        // 上記で見つからない場合は、より広範囲で検索
        if (allProductGroups.length === 0) {
            allProductGroups = document.querySelectorAll('.col-md-6, .col-lg-3, .col-sm-6');
            console.log('代替セレクターで商品群カード数:', allProductGroups.length);
        }
        
        // それでも見つからない場合は、カードクラスで検索
        if (allProductGroups.length === 0) {
            allProductGroups = document.querySelectorAll('.card, .modern-card');
            console.log('カードクラスで商品群カード数:', allProductGroups.length);
        }
        
        console.log('フィルター対象商品群数:', allProductGroups.length);
        
        // 商品群をフィルター
        allProductGroups.forEach(function(group, index) {
            if (selectedStage === 'all') {
                group.style.display = 'block';
                group.style.opacity = '1';
                console.log(`商品群${index + 1}: 表示`);
            } else {
                // ステージ番号バッジからdata-stage属性を取得
                const stageNumberBadge = group.querySelector('.stage-number-badge');
                if (stageNumberBadge) {
                    const stageKey = stageNumberBadge.getAttribute('data-stage');
                    console.log(`商品群${index + 1}のステージ: "${stageKey}", 選択ステージ: "${selectedStage}"`);
                    
                    if (stageKey === selectedStage) {
                        group.style.display = 'block';
                        group.style.opacity = '1';
                        console.log(`商品群${index + 1}: 表示 (ステージ: ${stageKey})`);
                    } else {
                        group.style.display = 'none';
                        group.style.opacity = '0.3';
                        console.log(`商品群${index + 1}: 非表示 (ステージ: ${stageKey})`);
                    }
                } else {
                    // バッジがない場合は表示
                    group.style.display = 'block';
                    group.style.opacity = '1';
                    console.log(`商品群${index + 1}: 表示 (バッジなし)`);
                }
            }
        });
        
        // フィルター状態を表示
        if (selectedStage !== 'all') {
            const stageNames = {
                'proposal_pre': '提案前',
                'estimate_completed': '見積書対応済',
                's_creation_approved': 'S作成承認済',
                'proposal_decision_obtained': '提案決裁取得済',
                'pre_production_s_confirmed': '量産前S確認済',
                'first_order': '初回発注済',
                'temporary_listing': '仮出品済',
                'page_up': 'ページアップ済',
                'second_lot_ordered': '2ロット目発注済'
            };
            
            // 安全にカウントを取得
            const selectedStageElements = document.querySelectorAll(`[data-stage="${selectedStage}"]`);
            let filteredCount = 0;
            
            if (selectedStageElements.length > 0) {
                const countBadge = selectedStageElements[0].querySelector('.stage-count-badge');
                if (countBadge && countBadge.textContent) {
                    filteredCount = parseInt(countBadge.textContent) || 0;
                }
            }
            
            // フィルター状態表示の要素が存在する場合のみ更新
            if (filterStatusText) {
                filterStatusText.textContent = `${stageNames[selectedStage]}の商品群を表示中 (${filteredCount}件)`;
            }
            
            if (filterStatus) {
                filterStatus.style.display = 'block';
            }
            
            // ヘッダーの解除ボタンを表示
            const resetFilterHeader = document.getElementById('reset-filter-header');
            if (resetFilterHeader) {
                resetFilterHeader.style.display = 'block';
            }
        } else {
            if (filterStatus) {
                filterStatus.style.display = 'none';
            }
            
            // ヘッダーの解除ボタンを非表示
            const resetFilterHeader = document.getElementById('reset-filter-header');
            if (resetFilterHeader) {
                resetFilterHeader.style.display = 'none';
            }
        }
    }
    
    // ステージクリックイベント
    filterableStages.forEach(function(stage) {
        stage.addEventListener('click', function() {
            const stageKey = this.getAttribute('data-stage');
            applyFilter(stageKey);
        });
    });
    
    // リセットボタン（サイドバー）
    resetFilterBtn.addEventListener('click', function() {
        applyFilter('all');
    });
    
    // メインフィルター解除ボタン
    const resetFilterMain = document.getElementById('reset-filter-main');
    if (resetFilterMain) {
        resetFilterMain.addEventListener('click', function() {
            applyFilter('all');
        });
    }
    
    // ヘッダーフィルター解除ボタン
    const resetFilterHeader = document.getElementById('reset-filter-header');
    if (resetFilterHeader) {
        resetFilterHeader.addEventListener('click', function() {
            applyFilter('all');
        });
    }
    
    // 初期化
    updateStageCounts();
}
</script>
{% endblock %}
