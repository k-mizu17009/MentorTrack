{% extends "base.html" %}

{% block title %}商品群別進捗分析 - {{ mentee.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>
                        <i class="fas fa-chart-line me-2"></i>商品群別進捗分析
                    </h2>
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        順調: 7日以内に報告 / 注意: 8-14日 / 停滞: 15日以上
                    </small>
                </div>
                <a href="{{ url_for('mentee_dashboard', mentee_id=mentee.id) }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> ダッシュボードに戻る
                </a>
            </div>


            <!-- 期間選択 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">分析期間の選択</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <form method="GET" class="d-flex align-items-center">
                                <label for="weeks" class="form-label me-3 mb-0">分析期間:</label>
                                <select name="weeks" id="weeks" class="form-select me-3" style="width: auto;" onchange="this.form.submit()">
                                    <option value="4" {% if selected_weeks == 4 %}selected{% endif %}>直近4週間</option>
                                    <option value="8" {% if selected_weeks == 8 %}selected{% endif %}>直近8週間</option>
                                    <option value="12" {% if selected_weeks == 12 %}selected{% endif %}>直近12週間</option>
                                    <option value="24" {% if selected_weeks == 24 %}selected{% endif %}>直近24週間</option>
                                    <option value="52" {% if selected_weeks == 52 %}selected{% endif %}>直近52週間（1年）</option>
                                </select>
                            </form>
                        </div>
                        <div class="col-md-4 text-end">
                            <small class="text-muted">
                                {{ product_group_progress|length }}個の商品群を分析中
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            {% if product_group_progress %}
            <div class="row">
                <!-- メインコンテンツ -->
                <div class="col-lg-9">
                    <!-- 進捗サマリー -->
                    <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-success">
                                <i class="fas fa-arrow-up"></i>
                                {{ product_group_progress|selectattr('progress_status', 'equalto', 'good')|list|length }}
                            </h5>
                            <p class="card-text">順調</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-warning">
                                <i class="fas fa-pause"></i>
                                {{ product_group_progress|selectattr('progress_status', 'equalto', 'warning')|list|length }}
                            </h5>
                            <p class="card-text">注意</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-danger">
                                <i class="fas fa-exclamation-triangle"></i>
                                {{ product_group_progress|selectattr('progress_status', 'equalto', 'danger')|list|length }}
                            </h5>
                            <p class="card-text">停滞</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-primary">
                                <i class="fas fa-boxes"></i>
                                {{ product_group_progress|length }}
                            </h5>
                            <p class="card-text">総商品群数</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 商品群別詳細分析 -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">商品群別詳細分析</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for pg in product_group_progress %}
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header py-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">{{ pg.name }}</h6>
                                        <span class="badge bg-{{ get_progress_status_info(pg.progress_status).class }}">
                                            <i class="{{ get_progress_status_info(pg.progress_status).icon }} me-1"></i>
                                            {{ get_progress_status_info(pg.progress_status).text }}
                                        </span>
                                    </div>
                                </div>
                                <div class="card-body py-2">
                                    <!-- 商品群画像 -->
                                    {% if pg.images %}
                                        {% set image_list = pg.images|from_json %}
                                        {% if image_list and image_list|length > 0 %}
                                        <div class="text-center mb-2">
                                            <img src="{{ url_for('static', filename='uploads/product_groups/' + image_list[0]) }}" 
                                                 class="img-fluid rounded" 
                                                 style="max-height: 80px; max-width: 100%; object-fit: contain;"
                                                 alt="{{ pg.name }}の画像">
                                        </div>
                                        {% endif %}
                                    {% endif %}
                                    
                                    <!-- 現在のステージ情報 -->
                                    <div class="row mb-2">
                                        <div class="col-6">
                                            <small class="text-muted">現在のステージ:</small><br>
                                            <span class="badge bg-primary">{{ get_stage_display_name(pg.current_stage) }}</span>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">最後の報告:</small><br>
                                            <span class="text-{{ get_progress_status_info(pg.progress_status).class }}">
                                                {{ pg.stage_duration }}日前
                                            </span>
                                        </div>
                                    </div>

                                    <!-- 進捗バー -->
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="text-muted">進捗状況</small>
                                            <small class="text-muted">
                                                {% set stage_progress = {
                                                    'proposal_pre': 11, 
                                                    'estimate_completed': 22, 
                                                    's_creation_approved': 33, 
                                                    'proposal_decision_obtained': 44, 
                                                    'pre_production_s_confirmed': 56, 
                                                    'first_order': 67, 
                                                    'temporary_listing': 78, 
                                                    'page_up': 89, 
                                                    'second_lot_ordered': 100
                                                } %}
                                                {{ stage_progress.get(pg.current_stage, 0) }}%
                                            </small>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar bg-{{ get_progress_status_info(pg.progress_status).class }}" 
                                                 role="progressbar" 
                                                 style="width: {{ stage_progress.get(pg.current_stage, 0) }}%"
                                                 aria-valuenow="{{ stage_progress.get(pg.current_stage, 0) }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 報告履歴（スクロール可能） -->
                                    <div class="mb-2">
                                        <small class="text-muted">報告履歴</small>
                                        {% if pg.reports %}
                                            <div class="mt-1 report-history-scroll">
                                                {% for report in pg.reports %}
                                                <div class="d-flex align-items-center mb-1 report-item" 
                                                     style="cursor: pointer; padding: 4px; border-radius: 4px; transition: background-color 0.2s; {% if report.self_evaluation and report.self_evaluation == 1 %}border-left: 3px solid #dc3545;{% elif report.self_evaluation and report.self_evaluation == 2 %}border-left: 3px solid #ffc107;{% endif %}" 
                                                     onmouseover="this.style.backgroundColor='#f8f9fa'" 
                                                     onmouseout="this.style.backgroundColor='transparent'"
                                                     onclick="window.location.href='{{ url_for('view_report', report_id=report.id) }}'">
                                                    <div class="bg-{{ get_progress_status_info(pg.progress_status).class }} me-2" style="width: 4px; height: 4px; border-radius: 50%;"></div>
                                                    <small class="text-muted flex-grow-1">
                                                        {{ report.date.strftime('%m/%d') }} - 
                                                        {{ get_stage_display_name(report.stage) }}
                                                        {% if report.self_evaluation %}
                                                            <span class="ms-1">
                                                                {% for i in range(1, 4) %}
                                                                    {% if i <= report.self_evaluation %}
                                                                        {% if report.self_evaluation == 1 %}
                                                                            <span class="text-danger">★</span>
                                                                        {% else %}
                                                                            <span class="text-warning">★</span>
                                                                        {% endif %}
                                                                    {% else %}
                                                                        <span class="text-muted">☆</span>
                                                                    {% endif %}
                                                                {% endfor %}
                                                            </span>
                                                        {% endif %}
                                                    </small>
                                                    <small class="text-muted">
                                                        <i class="fas fa-external-link-alt" style="font-size: 10px;"></i>
                                                    </small>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <small class="text-muted">報告なし</small>
                                        {% endif %}
                                    </div>

                                    <!-- 推奨アクション（簡略化） -->
                                    <div class="alert alert-{{ 'success' if pg.progress_status == 'good' else 'warning' if pg.progress_status == 'warning' else 'danger' }} alert-sm py-1">
                                        <small>
                                            {% if pg.progress_status == 'good' %}
                                                定期的に報告されています。継続してください。
                                            {% elif pg.progress_status == 'warning' %}
                                                1週間以上報告がありません。今週中に報告をお勧めします。
                                            {% elif pg.progress_status == 'danger' %}
                                                2週間以上報告がありません。早急にメンターと対策を検討してください。
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
                </div>
                
                <!-- サイドバー -->
                <div class="col-lg-3">
                    <!-- 進捗ステージ一覧 -->
                    <div class="card mb-4 sticky-top" style="top: 20px;">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-list-ol me-2"></i>進捗ステージ一覧
                            </h6>
                        </div>
                        <div class="card-body p-2">
                            <div class="progress-stages-sidebar">
                                <div class="progress-stage-item-sidebar" data-stage="proposal_pre">
                                    <div class="stage-number-sidebar">1</div>
                                    <div class="stage-info-sidebar">
                                        <div class="stage-name-sidebar">提案前</div>
                                        <div class="stage-percentage-sidebar">11%</div>
                                    </div>
                                </div>
                                <div class="progress-stage-item-sidebar" data-stage="estimate_completed">
                                    <div class="stage-number-sidebar">2</div>
                                    <div class="stage-info-sidebar">
                                        <div class="stage-name-sidebar">見積書対応済</div>
                                        <div class="stage-percentage-sidebar">22%</div>
                                    </div>
                                </div>
                                <div class="progress-stage-item-sidebar" data-stage="s_creation_approved">
                                    <div class="stage-number-sidebar">3</div>
                                    <div class="stage-info-sidebar">
                                        <div class="stage-name-sidebar">S作成承認済</div>
                                        <div class="stage-percentage-sidebar">33%</div>
                                    </div>
                                </div>
                                <div class="progress-stage-item-sidebar" data-stage="proposal_decision_obtained">
                                    <div class="stage-number-sidebar">4</div>
                                    <div class="stage-info-sidebar">
                                        <div class="stage-name-sidebar">提案決裁取得済</div>
                                        <div class="stage-percentage-sidebar">44%</div>
                                    </div>
                                </div>
                                <div class="progress-stage-item-sidebar" data-stage="pre_production_s_confirmed">
                                    <div class="stage-number-sidebar">5</div>
                                    <div class="stage-info-sidebar">
                                        <div class="stage-name-sidebar">量産前S確認済</div>
                                        <div class="stage-percentage-sidebar">56%</div>
                                    </div>
                                </div>
                                <div class="progress-stage-item-sidebar" data-stage="first_order">
                                    <div class="stage-number-sidebar">6</div>
                                    <div class="stage-info-sidebar">
                                        <div class="stage-name-sidebar">初回発注済</div>
                                        <div class="stage-percentage-sidebar">67%</div>
                                    </div>
                                </div>
                                <div class="progress-stage-item-sidebar" data-stage="temporary_listing">
                                    <div class="stage-number-sidebar">7</div>
                                    <div class="stage-info-sidebar">
                                        <div class="stage-name-sidebar">仮出品済</div>
                                        <div class="stage-percentage-sidebar">78%</div>
                                    </div>
                                </div>
                                <div class="progress-stage-item-sidebar" data-stage="page_up">
                                    <div class="stage-number-sidebar">8</div>
                                    <div class="stage-info-sidebar">
                                        <div class="stage-name-sidebar">ページアップ済</div>
                                        <div class="stage-percentage-sidebar">89%</div>
                                    </div>
                                </div>
                                <div class="progress-stage-item-sidebar" data-stage="second_lot_ordered">
                                    <div class="stage-number-sidebar">9</div>
                                    <div class="stage-info-sidebar">
                                        <div class="stage-name-sidebar">2ロット目発注済</div>
                                        <div class="stage-percentage-sidebar">100%</div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    進捗確認
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- データなしの場合 -->
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">分析データがありません</h5>
                    <p class="text-muted">週次報告を作成すると、ここに進捗分析が表示されます。</p>
                    <a href="{{ url_for('new_report', mentee_id=mentee.id) }}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>最初の報告を作成
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
/* サイドバー用進捗ステージ一覧のスタイリング */
.progress-stages-sidebar {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.progress-stage-item-sidebar {
    display: flex;
    align-items: center;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 6px 8px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.progress-stage-item-sidebar:hover {
    background: #e9ecef;
    border-color: #007bff;
    transform: translateX(2px);
}

.stage-number-sidebar {
    background: #007bff;
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: bold;
    margin-right: 6px;
    flex-shrink: 0;
}

.stage-info-sidebar {
    flex: 1;
    min-width: 0;
}

.stage-name-sidebar {
    font-size: 0.75rem;
    font-weight: 600;
    color: #495057;
    line-height: 1.2;
    margin-bottom: 1px;
}

.stage-percentage-sidebar {
    font-size: 0.65rem;
    color: #6c757d;
    font-weight: 500;
}

/* 現在のステージのハイライト（サイドバー用） */
.progress-stage-item-sidebar.current-stage {
    border-color: #28a745;
    background: #d4edda;
    box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
}

.progress-stage-item-sidebar.current-stage .stage-number-sidebar {
    background: #28a745;
}

.progress-stage-item-sidebar.completed-stage {
    border-color: #17a2b8;
    background: #d1ecf1;
}

.progress-stage-item-sidebar.completed-stage .stage-number-sidebar {
    background: #17a2b8;
}

/* レスポンシブ対応 */
@media (max-width: 992px) {
    .progress-stage-item-sidebar {
        padding: 8px 10px;
    }
    
    .stage-name-sidebar {
        font-size: 0.8rem;
    }
    
    .stage-percentage-sidebar {
        font-size: 0.7rem;
    }
    
    .stage-number-sidebar {
        width: 22px;
        height: 22px;
        font-size: 0.75rem;
    }
}

.timeline {
    position: relative;
    padding-left: 20px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 4px;
    top: 0;
    bottom: 0;
    width: 2px;
    background-color: #dee2e6;
}

.timeline-item {
    position: relative;
}

.timeline-marker {
    position: absolute;
    left: -20px;
    top: 50%;
    transform: translateY(-50%);
}

.alert-sm {
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
}

/* 報告履歴のスクロールバーをカスタマイズ */
.report-history-scroll {
    max-height: 80px;
    overflow-y: auto;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 8px;
}

.report-history-scroll::-webkit-scrollbar {
    width: 4px;
}

.report-history-scroll::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 2px;
}

.report-history-scroll::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 2px;
}

.report-history-scroll::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* 現在のステージのハイライト */
.progress-stage-item.current-stage {
    border-color: #28a745;
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
}

.progress-stage-item.current-stage .stage-number {
    background: #28a745;
}

.progress-stage-item.completed-stage {
    border-color: #17a2b8;
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
}

.progress-stage-item.completed-stage .stage-number {
    background: #17a2b8;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 現在のステージをハイライト表示（サイドバー用）
    function highlightCurrentStages() {
        const stageItems = document.querySelectorAll('.progress-stage-item-sidebar');
        const productGroups = document.querySelectorAll('.col-lg-3.col-md-6');
        
        // 各商品群の現在のステージを取得
        const currentStages = [];
        productGroups.forEach(function(group) {
            const badge = group.querySelector('.badge');
            if (badge) {
                const stageText = badge.textContent.trim();
                // ステージ名を抽出（表示名から内部名に変換）
                const stageMapping = {
                    '提案前': 'proposal_pre',
                    '見積書対応済': 'estimate_completed',
                    'S作成承認済': 's_creation_approved',
                    '提案決裁取得済': 'proposal_decision_obtained',
                    '量産前S確認済': 'pre_production_s_confirmed',
                    '初回発注済': 'first_order',
                    '仮出品済': 'temporary_listing',
                    'ページアップ済': 'page_up',
                    '2ロット目発注済': 'second_lot_ordered'
                };
                
                const stageKey = Object.keys(stageMapping).find(key => stageText.includes(key));
                if (stageKey) {
                    currentStages.push(stageMapping[stageKey]);
                }
            }
        });
        
        // ステージアイテムのハイライトを更新
        stageItems.forEach(function(item) {
            const stageId = item.getAttribute('data-stage');
            item.classList.remove('current-stage', 'completed-stage');
            
            if (currentStages.includes(stageId)) {
                item.classList.add('current-stage');
            } else {
                // 完了済みステージの判定（現在のステージより前のステージ）
                const stageOrder = [
                    'proposal_pre', 'estimate_completed', 's_creation_approved',
                    'proposal_decision_obtained', 'pre_production_s_confirmed',
                    'first_order', 'temporary_listing', 'page_up', 'second_lot_ordered'
                ];
                
                const currentStageIndex = Math.max(...currentStages.map(stage => stageOrder.indexOf(stage)));
                const itemIndex = stageOrder.indexOf(stageId);
                
                if (itemIndex < currentStageIndex && itemIndex >= 0) {
                    item.classList.add('completed-stage');
                }
            }
        });
    }
    
    // ページ読み込み時に実行
    highlightCurrentStages();
});
</script>
{% endblock %}
